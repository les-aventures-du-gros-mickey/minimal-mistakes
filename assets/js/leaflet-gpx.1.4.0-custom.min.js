/**
 * Copyright (C) 2011-2012 Pavel Shramov
 * Copyright (C) 2013-2017 Maxime Petazzoni <maxime.petazzoni@bulix.org>
 * All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * - Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 *
 * - Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Thanks to Pavel Shramov who provided the initial implementation and Leaflet
 * integration. Original code was at https://github.com/shramov/leaflet-plugins.
 *
 * It was then cleaned-up and modified to record and make available more
 * information about the GPX track while it is being parsed so that the result
 * can be used to display additional information about the track that is
 * rendered on the Leaflet map.
 */

/**
 * Remove pop-up for waypoints if no name is provided (line 394)
 * Remove default marker URLs (lines 56-58, 60-62)
 * Minify with jscompress.com
 */

var L=L||require("leaflet"),_MAX_POINT_INTERVAL_MS=15e3,_SECOND_IN_MILLIS=1e3,_MINUTE_IN_MILLIS=60*_SECOND_IN_MILLIS,_HOUR_IN_MILLIS=60*_MINUTE_IN_MILLIS,_DAY_IN_MILLIS=24*_HOUR_IN_MILLIS,_GPX_STYLE_NS="http://www.topografix.com/GPX/gpx_style/0/2",_DEFAULT_MARKER_OPTS={wptIcons:[],pointMatchers:[],iconSize:[33,50],shadowSize:[50,50],iconAnchor:[16,45],shadowAnchor:[16,47],clickable:!1},_DEFAULT_POLYLINE_OPTS={color:"blue"},_DEFAULT_GPX_OPTS={parseElements:["track","route","waypoint"]};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||_MAX_POINT_INTERVAL_MS,e.marker_options=this._merge_objs(_DEFAULT_MARKER_OPTS,e.marker_options||{}),e.polyline_options=e.polyline_options||{},e.gpx_options=this._merge_objs(_DEFAULT_GPX_OPTS,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";_DAY_IN_MILLIS<=t&&(n+=Math.floor(t/_DAY_IN_MILLIS)+"d ",t%=_DAY_IN_MILLIS),_HOUR_IN_MILLIS<=t&&(n+=Math.floor(t/_HOUR_IN_MILLIS)+":",t%=_HOUR_IN_MILLIS);var i=Math.floor(t/_MINUTE_IN_MILLIS);t%=_MINUTE_IN_MILLIS,i<10&&(n+="0"),n+=i+"'";var o=Math.floor(t/_SECOND_IN_MILLIS);return t%=_SECOND_IN_MILLIS,o<10&&(n+="0"),n+=o,n+=!e&&0<t?"."+Math.round(1e3*Math.floor(t))/1e3:'"'},get_duration_string_iso:function(t,e){return this.get_duration_string(t,e).replace("'",":").replace('"',"")},to_miles:function(t){return t/1.60934},to_ft:function(t){return 3.28084*t},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/36e5)},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/36e5)},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/36e5)},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/36e5)},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var e=this;return this._info.elevation._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" m"})})},get_elevation_data_imp:function(){var e=this;return this._info.elevation._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,e.to_ft,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var e=this;return this._info.hr._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" bpm"})})},get_heartrate_data_imp:function(){var e=this;return this._info.hr._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" bpm"})})},get_cadence_data:function(){var e=this;return this._info.cad._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" rpm"})})},get_temp_data:function(){var e=this;return this._info.atemp._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" degrees"})})},get_cadence_data_imp:function(){var e=this;return this._info.cad._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" rpm"})})},get_temp_data_imp:function(){var e=this;return this._info.atemp._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var i in t)n[i]=t[i];for(var i in e)n[i]=e[i];return n},_prepare_data_point:function(t,e,n,i){var o=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return o.push(i&&i(o[0],o[1])||o[0]+": "+o[1]),o},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,i){null==i&&(i=this.options.async),null==n&&(n=this.options);var o=new window.XMLHttpRequest;o.open("GET",t,i);try{o.overrideMimeType("text/xml")}catch(t){}o.onreadystatechange=function(){4==o.readyState&&200==o.status&&e(o.responseXML,n)},o.send(null)},_parse:function(t,e,n){function i(t,e){var n=a._parse_gpx_data(t,e);n&&(a.addLayer(n),a.fire("loaded",{layers:n,element:t}))}var o,a=this;"<"===t.substr(0,1)?(o=new DOMParser,n?setTimeout(function(){i(o.parseFromString(t,"text/xml"),e)}):i(o.parseFromString(t,"text/xml"),e)):this._load_xml(t,i,e,n)},_parse_gpx_data:function(t,e){var n,i,o,a=[],_=[],r=e.gpx_options.parseElements;-1<r.indexOf("route")&&_.push(["rte","rtept"]),-1<r.indexOf("track")&&_.push(["trkseg","trkpt"]),0<(u=t.getElementsByTagName("name")).length&&(this._info.name=u[0].textContent),0<(f=t.getElementsByTagName("desc")).length&&(this._info.desc=f[0].textContent);var s=t.getElementsByTagName("author");0<s.length&&(this._info.author=s[0].textContent);var l=t.getElementsByTagName("copyright");for(0<l.length&&(this._info.copyright=l[0].textContent),i=0;i<_.length;i++)for(o=t.getElementsByTagName(_[i][0]),n=0;n<o.length;n++)for(var m=this._parse_trkseg(o[n],e,_[i][1]),h=0;h<m.length;h++)a.push(m[h]);if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),-1<r.indexOf("waypoint"))for(o=t.getElementsByTagName("wpt"),n=0;n<o.length;n++){var p=new L.LatLng(o[n].getAttribute("lat"),o[n].getAttribute("lon")),g=o[n].getElementsByTagName("name"),u="";0<g.length&&(u=g[0].textContent);var c=o[n].getElementsByTagName("desc"),f="";0<c.length&&(f=c[0].textContent);var d=o[n].getElementsByTagName("sym"),v="";0<d.length&&(v=d[0].textContent);var I,x=e.marker_options.wptIcons,M=e.marker_options.wptIconUrls;if(x&&x[v])I=x[v];else if(M&&M[v])I=new L.GPXTrackIcon({iconUrl:M[v]});else if(x&&x[""])I=x[""];else{if(!M||!M[""]){console.log('No icon or icon URL configured for symbol type "'+v+'", and no fallback configured; ignoring waypoint.');continue}I=new L.GPXTrackIcon({iconUrl:M[""]})}var k=new L.Marker(p,{clickable:e.marker_options.clickable,title:u,icon:I});0<u.length&&k.bindPopup("<b>"+u+"</b>"+(0<f.length?"<br>"+f:"")).openPopup(),this.fire("addpoint",{point:k,point_type:"waypoint",element:o[n]}),a.push(k)}return 1<a.length?new L.FeatureGroup(a):1==a.length?a[0]:void 0},_parse_trkseg:function(t,e,n){var i=t.getElementsByTagName(n);if(!i.length)return[];for(var o=[],a=[],_=[],r=null,s=0;s<i.length;s++){var l,m=new L.LatLng(i[s].getAttribute("lat"),i[s].getAttribute("lon"));if(m.meta={time:null,ele:null,hr:null,cad:null,atemp:null},0<(u=i[s].getElementsByTagName("time")).length?m.meta.time=new Date(Date.parse(u[0].textContent)):m.meta.time=new Date("1970-01-01T00:00:00"),0<(u=i[s].getElementsByTagName("ele")).length&&(m.meta.ele=parseFloat(u[0].textContent)),0<(u=i[s].getElementsByTagName("name")).length)for(var h=u[0].textContent,p=e.marker_options.pointMatchers||[],g=0;g<p.length;g++)if(p[g].regex.test(h)){a.push({label:h,coords:m,icon:p[g].icon,element:i[s]});break}0<(u=i[s].getElementsByTagNameNS("*","hr")).length&&(m.meta.hr=parseInt(u[0].textContent),this._info.hr._points.push([this._info.length,m.meta.hr]),this._info.hr._total+=m.meta.hr),0<(u=i[s].getElementsByTagNameNS("*","cad")).length&&(m.meta.cad=parseInt(u[0].textContent),this._info.cad._points.push([this._info.length,m.meta.cad]),this._info.cad._total+=m.meta.cad),0<(u=i[s].getElementsByTagNameNS("*","atemp")).length&&(m.meta.atemp=parseInt(u[0].textContent),this._info.atemp._points.push([this._info.length,m.meta.atemp]),this._info.atemp._total+=m.meta.atemp),m.meta.ele>this._info.elevation.max&&(this._info.elevation.max=m.meta.ele),m.meta.ele<this._info.elevation.min&&(this._info.elevation.min=m.meta.ele),this._info.elevation._points.push([this._info.length,m.meta.ele]),this._info.duration.end=m.meta.time,null!=r?(this._info.length+=this._dist3d(r,m),0<(l=m.meta.ele-r.meta.ele)?this._info.elevation.gain+=l:this._info.elevation.loss+=Math.abs(l),l=Math.abs(m.meta.time-r.meta.time),this._info.duration.total+=l,l<e.max_point_interval&&(this._info.duration.moving+=l)):null==this._info.duration.start&&(this._info.duration.start=m.meta.time),r=m,o.push(m)}var u,c=this._merge_objs(_DEFAULT_POLYLINE_OPTS,{}),f=t.getElementsByTagNameNS(_GPX_STYLE_NS,"line");0<f.length&&(0<(u=f[0].getElementsByTagName("color")).length&&(c.color="#"+u[0].textContent),0<(u=f[0].getElementsByTagName("opacity")).length&&(c.opacity=u[0].textContent),0<(u=f[0].getElementsByTagName("weight")).length&&(c.weight=u[0].textContent),0<(u=f[0].getElementsByTagName("linecap")).length&&(c.lineCap=u[0].textContent));var d=new L.Polyline(o,this._merge_objs(c,e.polyline_options));this.fire("addline",{line:d,element:t}),_.push(d),(e.marker_options.startIcon||e.marker_options.startIconUrl)&&(v=new L.Marker(o[0],{clickable:e.marker_options.clickable,icon:e.marker_options.startIcon||new L.GPXTrackIcon({iconUrl:e.marker_options.startIconUrl})}),this.fire("addpoint",{point:v,point_type:"start",element:i[0]}),_.push(v)),(e.marker_options.endIcon||e.marker_options.endIconUrl)&&(v=new L.Marker(o[o.length-1],{clickable:e.marker_options.clickable,icon:e.marker_options.endIcon||new L.GPXTrackIcon({iconUrl:e.marker_options.endIconUrl})}),this.fire("addpoint",{point:v,point_type:"end",element:i[i.length-1]}),_.push(v));for(s=0;s<a.length;s++){var v=new L.Marker(a[s].coords,{clickable:e.marker_options.clickable,title:a[s].label,icon:a[s].icon});this.fire("addpoint",{point:v,point_type:"label",element:a[s].element}),_.push(v)}return _},_dist2d:function(t,e){var n=this._deg2rad(e.lat-t.lat),i=this._deg2rad(e.lng-t.lng),o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},_dist3d:function(t,e){var n=this._dist2d(t,e),i=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(i,2))},_deg2rad:function(t){return t*Math.PI/180}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=L:"function"==typeof define&&define.amd&&define(L);
